use master
go
if DB_ID('QLGV_TGDT') is not null
	drop database QLGV_TGDT
go

create database QLGV_TGDT
go

use QLGV_TGDT
go

create table GIAOVIEN
(
	MAGV CHAR(3),
	HOTEN NVARCHAR(50),
	LUONG INT,
	PHAI NVARCHAR(10),
	NGSINH DATE,
	DIACHI NVARCHAR(50),
	GVQLCM CHAR(3),
	MABM VARCHAR(10)

	CONSTRAINT PK_GV
	PRIMARY KEY (MAGV)
)

create table BOMON
(
	MABM VARCHAR(10),
	TENBM NVARCHAR(50),
	PHONG CHAR(3),
	DIENTHOAI VARCHAR(10),
	TRUONGBM CHAR(3),
	MAKHOA VARCHAR(10),
	NGAYNHANCHUC DATE

	CONSTRAINT PK_BM
	PRIMARY KEY (MABM)
)

create table KHOA
(
	MAKHOA VARCHAR(10),
	TENKHOA NVARCHAR(50),
	NAMTL INT,
	PHONG CHAR(3),
	DIENTHOAI CHAR(10),
	TRUONGKHOA CHAR(3),
	NGAYNHANCHUC DATE

	CONSTRAINT PK_KHOA
	PRIMARY KEY (MAKHOA)
)

create table GV_DT
(
	MAGV CHAR(3),
	DIENTHOAI CHAR(10)

	CONSTRAINT PK_GVDT
	PRIMARY KEY (MAGV, DIENTHOAI)
)

create table NGUOITHAN
(
	MAGV CHAR(3),
	TEN NVARCHAR(50),
	NGSINH DATE,
	PHAI NVARCHAR(10),
	QUANHE NVARCHAR(15)

	CONSTRAINT PK_NGUOITHAN
	PRIMARY KEY (MAGV, TEN)
)

create table THAMGIADT
(
	MAGV CHAR(3),
	MADT CHAR(3),
	STT INT,
	PHUCAP FLOAT,
	KETQUA NVARCHAR(30)

	CONSTRAINT PK_THAMGIADT
	PRIMARY KEY (MAGV, MADT, STT)
)

create table CONGVIEC
(
	MADT CHAR(3),
	STT INT,
	TENCV NVARCHAR(50),
	NGAYBD DATE,
	NGAYKT DATE,

	CONSTRAINT PK_CONGVIEC
	PRIMARY KEY (MADT, STT)
)

create table DETAI
(
	MADT CHAR(3),
	TENDT NVARCHAR(50),
	CAPQL NVARCHAR(50),
	KINHPHI INT,
	NGAYBD DATE,
	NGAYKT DATE,
	MACD VARCHAR(10),
	GVCNDT CHAR(3)

	CONSTRAINT PK_DETAI
	PRIMARY KEY (MADT)
)

create table CHUDE
(
	MACD VARCHAR(10),
	TENCD NVARCHAR(50)

	CONSTRAINT PK_CHUDE
	PRIMARY KEY (MACD)
)

alter table GIAOVIEN
add
	CONSTRAINT FK_GV_BM
	FOREIGN KEY (MABM)
	REFERENCES BOMON,

	CONSTRAINT FK_GV_GVQLCM
	FOREIGN KEY (GVQLCM)
	REFERENCES GIAOVIEN

alter table BOMON
add
	CONSTRAINT FK_BM_K
	FOREIGN KEY (MAKHOA)
	REFERENCES KHOA,

	CONSTRAINT FK_BM_GV
	FOREIGN KEY (TRUONGBM)
	REFERENCES GIAOVIEN

alter table KHOA
add 
	CONSTRAINT FK_K_GV
	FOREIGN KEY (TRUONGKHOA)
	REFERENCES GIAOVIEN

alter table GV_DT
add
	CONSTRAINT FK_GVDT_GV
	FOREIGN KEY (MAGV)
	REFERENCES GIAOVIEN

alter table NGUOITHAN
add
	CONSTRAINT FK_NT_GV
	FOREIGN KEY (MAGV)
	REFERENCES GIAOVIEN

alter table THAMGIADT
add
	CONSTRAINT FK_TGDT_GV
	FOREIGN KEY (MAGV)
	REFERENCES GIAOVIEN,

	CONSTRAINT FK_TGDT_CV
	FOREIGN KEY (MADT, STT)
	REFERENCES CONGVIEC

alter table CONGVIEC
add 
	CONSTRAINT FK_CV_DT
	FOREIGN KEY (MADT)
	REFERENCES DETAI

alter table DETAI
add
	CONSTRAINT FK_DT_GV
	FOREIGN KEY (GVCNDT)
	REFERENCES GIAOVIEN,

	CONSTRAINT FK_DT_CD
	FOREIGN KEY (MACD)
	REFERENCES CHUDE

-- Nhap lieu: BOMON --> GIAOVIEN --> KHOA
INSERT BOMON
VALUES
	('CNTT', N'Công nghệ tri thức', 'B15','0838126126', null, null, null ),
	('HHC', N'Hóa huữ cơ', 'B44','838222222', null, null, null ),
	('HL', N'Hóa lý', 'B42','0838878787', null, null, null ),
	('HPT', N'Hóa phân tích', 'B43','0838777777', null, null, '10-15-2007' ),
	('HTTT', N'Hệ thống thông tin', 'B13','0838125125', null, null, '9-20-2004'),
	('MMT', N'Mạng máy tính', 'B16','0838676767', null, null, '5-15-2005'),
	('SH', N'Sinh hóa', 'B33','0838898989', null, null, null),
	('VLĐT', N'Vật lý điện tử', 'B23','0838234234', null, null, null),
	('VLƯD', N'Vật lý ứng dụng', 'B24','0838454545', null, null, '2-18-2006'),
	('VS', N'Vi sinh', 'B32','0838909090', null, null, '1-1-2007')

INSERT GIAOVIEN
VALUES
	('001', N'Nguyễn Hoài An', 2000, 'Nam', '2-15-1973', N'25/3 Lạc Long Quân, Q.10, TP HCM', null, 'MMT'),
	('002', N'Trần Trà Hương', 2500, N'Nữ', '6-20-1960', N'125 Trần Hưng Đạo, Q.1, TP HCM', null, 'HTTT'),
	('003', N'Nguyễn Ngọc Ánh', 2200, N'Nữ', '5-11-1975', N'12/21 Võ Văn Ngân Thủ Đức, TP HCM', '002', 'HTTT'),
	('004', N'Trương Nam Sơn', 2300, 'Nam', '6-20-1959', N'215 Lạc Long Quân, TP Biên Hòa', null, 'VS'),
	('005', N'Lý Hoàng Hà', 2500, 'Nam', '10-23-1954', N'22/5 Nguyễn Xí, Q.Bình Thạnh, TP HCM', null, 'VLĐT'),
	('006', N'Trần Bạch Tuyết', 1500, N'Nữ', '5-20-1980', N'127 Hùng Vương, TP Mỹ Tho', '004', 'VS'),
	('007', N'Nguyễn An Trung', 2100, 'Nam', '6-5-1976', N'234 3/2, TP Biên Hòa', null, 'HPT'),
	('008', N'Trần Trung Hiếu', 1800, 'Nam', '11-22-1977', N'22/11 Lý Thường Kiệt, TP Mỹ Tho', '007', 'HPT'),
	('009', N'Trần Hoàng Nam', 2000, 'Nam', '11-22-1975', N'234 Trần Não, An Phú, TP HCM', '001', 'MMT'),
	('010', N'Phạm Nam Thanh', 1500, 'Nam', '12-12-1980', N'221 Hùng Vương, Q.5, TP HCM', '007', 'HPT')

INSERT KHOA
VALUES
	('CNTT', N'Công nghệ thông tin', 1995, 'B11', '0838123456', '002','02-20-2005'),
	('HH', N'Hóa học', 1980, 'B41', '0838456456', '007','10-15-2001'),
	('SH', N'Sinh học', 1980, 'B31', '0838454545', '004','10-11-2000'),
	('VL', N'Vật lý', 1976, 'B21', '0838223223', '005','09-18-2003')

-- Cập nhật dữ liệu 
---- Set TRUONGBM và MAKHOA cho BOMON 
UPDATE BOMON
SET TRUONGBM = '007', MAKHOA = 'HH'
WHERE MABM = 'HPT'
UPDATE BOMON
SET TRUONGBM = '002', MAKHOA = 'CNTT'
WHERE MABM = 'HTTT'
UPDATE BOMON
SET TRUONGBM = '001', MAKHOA = 'CNTT'
WHERE MABM = 'MMT'
UPDATE BOMON
SET TRUONGBM = '005', MAKHOA = 'VL'
WHERE MABM = 'VLƯD'
UPDATE BOMON
SET TRUONGBM = '004', MAKHOA = 'SH'
WHERE MABM = 'VS'

INSERT GV_DT
VALUES
	('001','0838912112'),
	('001','0903123123'),
	('002','0913454545'),
	('003','0838121212'),
	('003','0903656565'),
	('003','0937125125'),
	('006','0937888888'),
	('008','0653717171'),
	('008','0913232323')

INSERT NGUOITHAN
VALUES
	('001',N'Hùng','01-14-1990','Nam','Con'),
	('001',N'Thủy','12-8-1994',N'Nữ','Vợ'),
	('003',N'Hà','9-3-1998',N'Nữ','Con'),
	('003',N'Thu','9-3-1998',N'Nữ','Con'),
	('007',N'Mai','3-26-2003',N'Nữ','Con'),
	('007',N'Vy','2-14-2000',N'Nữ','Con'),
	('008',N'Nam','05-06-1991','Nam','Cháu'),
	('009',N'An','08-19-1996','Nam','Em'),
	('010',N'Nguyệt','1-14-2006',N'Nữ','Con')

INSERT CHUDE 
VALUES 
	('NCPT', N'Nghiên cứu phát triển'),
	('QLGD', N'Quản lý giáo dục'),
	('UDCN', N'Ứng dụng công nghệ')

INSERT DETAI 
VALUES 
	('001',N'HTTT quản lý các trường ĐH','ĐHQG',20,'10-20-2007','10-20-2008','QLGD','002'),
	('002',N'HTTT quản lý cho một khoa',N'Trường',20,'10-12-2000','10-12-2001','QLGD','002'),
	('003',N'Nghiên cứu chế tạo sợi Nanô Platin','ĐHQG',300,'5-15-2008','5-15-2010','NCPT','005'),
	('004',N'Tạo vật liệu sinh học bằng màng ối người',N'Nhà nước',100,'1-1-2007','12-31-2009','NCPT','004'),
	('005',N'Ứng dụng hóa học xanh',N'Trường',200,'10-10-2003','12-10-2004','UDCN','007'),
	('006',N'Nghiên cứu tế bào gốc',N'Nhà nước',4000,'10-20-2006','10-20-2009','NCPT','004'),
	('007',N'HTTT quản lý thư viện ở các trường ĐH',N'Trường',20,'5-10-2009','5-10-2010','QLGD','001')

INSERT CONGVIEC 
VALUES 
	('001', 1, N'Khởi tạo và Lập kế hoạch','10-20-2007', '12-20-2008'),
	('001', 2, N'Xác định yêu cầu','12-21-2008', '3-21-2008'),
	('001', 3, N'Phân tích hệ thống','3-22-2008', '5-22-2008'),
	('001', 4, N'Thiết kế hệ thống','5-23-2008', '6-23-2008'),
	('001', 5, N'Cài đặt thử nghiệm','6-24-2008', '10-20-2008'),
	('002', 1, N'Khởi tạo và Lập kế hoạch','5-10-2009', '7-10-2009'),
	('002', 2, N'Xác định yêu cầu','7-11-2009', '10-11-2009'),
	('002', 3, N'Phân tích hệ thống','10-12-2009', '12-20-2009'),
	('002', 4, N'Thiết kế hệ thống','12-21-2009', '3-22-2010'),
	('002', 5, N'Cài đặt thử nghiệm','3-23-2010', '5-10-2010'),
	('006', 1, N'Lấy mẫu','10-20-2006', '2-20-2007'),
	('006', 2, N'Nuôi cấy','2-21-2007', '8-21-2008')

INSERT THAMGIADT 
VALUES 
	('001', '002', 1, 0.0, null),
	('001', '002', 2, 2.0, null),
	('002', '001', 4, 2.0, N'Đạt'),
	('003', '001', 1, 1.0, N'Đạt'),
	('003', '001', 2, 0.0, N'Đạt'),
	('003', '001', 4, 1.0, N'Đạt'),
	('003', '002', 2, 0.0, null),
	('004', '006', 1, 0.0, N'Đạt'),
	('004', '006', 2, 1.0, N'Đạt'),
	('006', '006', 2, 1.5, N'Đạt'),
	('009', '002', 3, 0.5, null),
	('009', '002', 4, 1.5, null)


-- Truy vấn lồng = truy vấn con lồng vào vào mệnh đề truy vấn cha. Có 2 loại 
---- 1. Phân cấp: Truy vấn con chạy độc lập 
--------- Truy vấn con nằm trong các mệnh đề: where, from, having 

--------- MỆNH ĐỀ FROM 
-------vd: Cho biết giáo viên họ "nguyễn"/, số lượng công việc GVCN/, số lượng GV mà ng này quản lý 
--SELECT GV.*,DT.SODT,QL.SOGVQL
--FROM GIAOVIEN GV, (SELECT GVCNDT, COUNT(*) SODT
--					FROM DETAI DT
--					GROUP BY GVCNDT),
--					(SELECT GVQLCM, COUNT(MAGV)
--					FROM GIAOVIEN QL
--					GROUP BY GVQLCM) QL
--WHERE QL.GVQLCM=GV.MAGV AND DT.GVCNDT = GV.MAGV AND GV.HOTEN LIKE N'Nguyễn %'

--- CHO bIẾT HOTEN GV, SỐ CON, SỐ ĐÈ TÀI THAM GIA, TÊN QL, TÊN TRƯỞNG BM 
SELECT GV.HOTEN, TG.SODT, QL.HOTEN -- , NT.SOCON 
FROM GIAOVIEN GV, --(SELECT MAGV, COUNT(TEN) SOCON
--					FROM NGUOITHAN NT
--					WHERE NT.QUANHE LIKE '%CON%'
--					GROUP BY MAGV) NT ,
					(SELECT MAGV, COUNT(DISTINCT MADT) SODT
					FROM THAMGIADT TG
					GROUP BY MAGV) TG ,
					(SELECT MAGV, HOTEN
					FROM GIAOVIEN) QL
WHERE  TG.MAGV = GV.MAGV AND GV.GVQLCM = QL.MAGV --GV.MAGV = NT.MAGV AND
SELECT * FROM GIAOVIEN

-- MENH DE WHERE => DL XUẤT RA THỎA ĐK GÌ , CÓ BN ĐK THÌ LỒNG VÀO 
--VD: CHO BIẾT GV KO THAM GIA ĐỀ TÀI, HOẶC KO CÓ CON 
SELECT *
FROM GIAOVIEN
WHERE MAGV NOT IN (SELECT MAGV
					FROM THAMGIADT)
OR MAGV NOT IN (SELECT MAGV
				FROM NGUOITHAN
				WHERE QUANHE LIKE 'CON%')
-- CHO BIEETS GV LỚN TUỔI NHAT
SELECT *
FROM GIAOVIEN GV
WHERE GV.NGSINH <= ALL (SELECT NGSINH 
						FROM GIAOVIEN
						WHERE NGSINH IS NOT NULL )
AND NGSINH IS NOT NULL -- CÁI GÌ SO VỚI NULL CŨNG RA NULL ==> KTRA NULL 

--MENH DE HAVING
--VD: CHO BIET GIAO VIEN DONG CON NHAT
SELECT MAGV
FROM NGUOITHAN TN
WHERE TN.QUANHE LIKE 'CON%'
GROUP BY MAGV 
HAVING COUNT(TEN) >= ALL (SELECT MAGV
							FROM NGUOITHAN TN
							WHERE TN.QUANHE LIKE 'CON%'
							GROUP BY MAGV) -- DỀ CK CÓ 


---- 2. Tương QUAN: Truy vấn con truy xuất truy vấn cha 
--------- mệnh đề: SELECT, FROM, WHERE, HAVING 
-- MỆNH ĐỀ SELECT : XUẤT GTRI RA 
-- CHO BIÊT HỌ TÊN GV, SỐ ĐT THAM GIA, TÊN QL, TÊN TRƯỞNG BM 
SELECT GV.HOTEN, (SELECT COUNT(DISTINCT MADT)
					FROM THAMGIADT TG
					WHERE TG.MAGV = GV.MAGV) SODT,
					(SELECT HOTEN
					FROM GIAOVIEN QL
					WHERE QL.MAGV = GV.GVQLCM) TENQL,
					(SELECT HOTEN
					FROM BOMON BM JOIN GIAOVIEN TBM ON BM.TRUONGBM = TBM.MAGV
					WHERE BM.MABM = GV.MABM) TENTBM
FROM GIAOVIEN GV

-- TƯƠNG QUAN WHERE 

--VD: CHO BIẾT GV KO THAM GIA ĐỀ TÀI 
SELECT *
FROM GIAOVIEN GV
WHERE NOT EXISTS (SELECT *
					FROM THAMGIADT TG
					WHERE TG.MAGV = GV.MAGV) -- DK DAY VAO BEN TRONG, DUNG CHO 2 CAP 

SELECT *
FROM GIAOVIEN GV
WHERE GV.MAGV NOT IN (SELECT MAGV
					FROM THAMGIADT TG) -- DK O BEN NGOAI, DUNG CHO 1 CAP 
--VD: CHO BIẾT GV KO THAM GIA ĐỀ TÀI DO GV CÙNG BỘ MÔN CHỦ NHIỆM 
SELECT GV.*
FROM THAMGIADT TG JOIN GIAOVIEN GV ON GV.MAGV = TG.MAGV
WHERE TG.MADT NOT IN (SELECT DT.MADT
						FROM DETAI DT JOIN GIAOVIEN CN ON CN.MAGV = DT.GVCNDT
						WHERE DT.MADT = TG.MADT AND CN.MABM = GV.MABM)
-- TUONG QUAN HAVING
--VD: CHO BIET GV CÓ NHIỀU CON NHẤT TRONG CÙNG BỘ MÔN 
SELECT TN.MAGV
FROM NGUOITHAN TN JOIN GIAOVIEN GV ON GV.MAGV = TN.MAGV
WHERE TN.QUANHE LIKE 'CON%'
GROUP BY TN.MAGV , GV.MABM
HAVING COUNT(TEN) >= ALL (SELECT COUNT(TEN)
							FROM NGUOITHAN TN1 JOIN GIAOVIEN GV1 
							ON GV1.MAGV = TN1.MAGV
							WHERE TN1.QUANHE LIKE 'CON%' AND GV1.MABM = GV.MABM
							GROUP BY TN1.MAGV)
--6. CHO BIẾT GIÁO VIÊN THAM GIA ĐỀ TÀI BẮT ĐẦU VÀ KẾT THÚC TRONG NĂM 2008
SELECT GV.HOTEN, DT.NGAYBD, DT.NGAYKT
FROM GIAOVIEN GV JOIN THAMGIADT TGDT ON  GV.MAGV= TGDT.MAGV 
JOIN DETAI DT ON DT.MADT=TGDT.MADT
WHERE DT.NGAYBD LIKE '%2008%' AND DT.NGAYKT LIKE '%2008%'

--8. CHO BIẾT TÊN BM, LƯƠNG TRUNG BÌNH VÀ SỐ LƯỢNG GIÁO VIÊN CỦA BM CÓ TRƯỞNG BM HỌ "NGUYỄN" TÊN "AN"

SELECT GV.HOTEN
FROM BOMON BM
JOIN GIAOVIEN GV ON GV.MABM = BM.MABM
WHERE BM.TRUONGBM IN (
    SELECT MAGV
    FROM GIAOVIEN
    WHERE HOTEN LIKE N'Nguyễn%An'
)
--10. CHO BIẾT HOTEN, LƯƠNG CỦA GIÁO VIÊN LỚN TUỔI HƠN TRƯỞNG BỘ MÔN CỦA MÌNH
SELECT GV.HOTEN, GV.LUONG
FROM GIAOVIEN GV JOIN BOMON TBM ON GV.MABM = TBM.MABM  
JOIN GIAOVIEN GV1 ON TBM.TRUONGBM = GV1.MAGV
WHERE GV.NGSINH < GV1.NGSINH AND GV.NGSINH IS NOT NULL AND GV1.NGSINH IS NOT NULL

--14. CHO BIẾT GIÁO VIÊN CHỦ NHIỆM NHIỀU ĐỀ TÀI CÓ CÔNG VIỆC KHÔNG ĐẠT NHẤT

SELECT GV.MAGV, COUNT(GV.MAGV) DETAI_KODAT
FROM GIAOVIEN GV, THAMGIADT TG, DETAI DT
WHERE TG.KETQUA IS NULL AND TG.MADT = DT.MADT AND DT.GVCNDT = GV.MAGV
GROUP BY GV.MAGV
HAVING COUNT(GV.MAGV) >= ALL (SELECT COUNT(GV1.MAGV)
							FROM GIAOVIEN GV1, THAMGIADT TG1, DETAI DT1
							WHERE TG1.KETQUA IS NULL AND TG1.MADT = DT1.MADT AND DT1.GVCNDT = GV1.MAGV
							GROUP BY GV1.MAGV)
--16. CHO BIẾT GIÁO VIÊN CHƯA THAM GIA ĐỀ TÀI NÀO DO GIÁO VIÊN CÙNG BỘ MÔN CHỦ NHIỆM
SELECT DISTINCT GV.*
FROM THAMGIADT TG JOIN GIAOVIEN GV ON GV.MAGV = TG.MAGV
WHERE NOT EXISTS (SELECT *
				FROM DETAI DT  JOIN GIAOVIEN CN ON
				CN.MAGV = DT.GVCNDT
				WHERE DT.MADT = TG.MADT AND
				CN.MABM = GV.MABM)
--2. CHO BIẾT HỌ TÊN, TÊN BM, THUẾ (=10% LƯƠNG) VÀ TUỔI CỦA GVNCDT '001'
select GV.HoTen, (select TENBM from BOMON BM where BM.MaBM = GV.MaBM) TenBM,GV.Luong * 0.1 as Thue, (DATEDIFF(YYYY, GV.NGSINH, GETDATE())) Tuoi
from GiaoVien GV join DeTai DT on GV.MaGV = DT.GVCNDT 
where DT.GVCNDT = '001'
--4. CHO BIẾT HOTEN GV, TÊN NGƯỜI QUẢN LÝ CỦA GIÁO VIÊN THUỘC BM TRONG TÊN CÓ TỪ 'CÔNG NGHỆ'
select (select HoTen from GiaoVien GV where GV.MaGV = GV. GVQLCM and BM.TenBM like N'%Công nghệ%') HoTen, (select HoTen from GiaoVien QL where QL.MaGV = GV. GVQLCM and BM.TenBM like N'%Công nghệ%') TenQL
from GiaoVien GV join BoMon BM on GV.MaBM = BM.MaBM

--18. CHO BIẾT GIÁO VIÊN CÙNG SỐ CON VÀ CÙNG GIỚI TÍNH VỚI GIÁO VIÊN KHÁC
SELECT GV1.HOTEN GIAOVIEN1, GV2.HOTEN GIAOVIEN2
FROM GIAOVIEN GV1
JOIN GIAOVIEN GV2 ON GV1.PHAI = GV2.PHAI AND GV1.MAGV <> GV2.MAGV
JOIN (
    SELECT MAGV, COUNT(*) AS SOLUONGCON
    FROM NGUOITHAN NT
    WHERE NT.QUANHE = 'CON'
    GROUP BY MAGV
) AS NT1 ON GV1.MAGV = NT1.MAGV
JOIN (
    SELECT MAGV, COUNT(*) AS SOLUONGCON
    FROM NGUOITHAN NT
    WHERE NT.QUANHE = 'CON'
    GROUP BY MAGV
) AS NT2 ON GV2.MAGV = NT2.MAGV
WHERE NT1.SOLUONGCON = NT2.SOLUONGCON;


